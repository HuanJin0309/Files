name: Auto Build on Target Repo Update
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯ä¸¤å¤© 00:00 æ£€æµ‹ç›®æ ‡ä»“åº“æ›´æ–°ï¼ˆå¯è°ƒæ•´ cron è¡¨è¾¾å¼ï¼‰
  schedule:
    - cron: '0 0 */2 * *'  # cron æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨ï¼Œ*/2 è¡¨ç¤ºæ¯2å¤©æ‰§è¡Œä¸€æ¬¡
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub é¡µé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œï¼ˆç´§æ€¥åœºæ™¯å¤‡ç”¨ï¼‰
  workflow_dispatch:

jobs:
  check-update-and-trigger-build:
    runs-on: ubuntu-latest  # è½»é‡ Linux ç¯å¢ƒï¼Œé€‚åˆæ£€æµ‹é€»è¾‘ï¼ˆèµ„æºå ç”¨ä½ï¼‰
    # æƒé™æ§åˆ¶ï¼šä»…æŒ‡å®šä»“åº“æ‰€æœ‰è€…å¯è§¦å‘ï¼ˆé¿å…ä»–äºº fork åè¯¯æ‰§è¡Œï¼Œéœ€ä¿®æ”¹ä¸ºä½ çš„ä»“åº“æ‰€æœ‰è€…åˆ—è¡¨ï¼‰
    if: contains(fromJSON('["huanjin0309"]'), github.repository_owner)
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ç”¨äºæ“ä½œä»“åº“åˆ†æ”¯ï¼ˆè®°å½• SHAï¼‰
          fetch-depth: 0  # æ‹‰å–å®Œæ•´ä»“åº“å†å²ï¼Œç¡®ä¿åˆ†æ”¯æ“ä½œæ­£å¸¸

      - name: Get latest commit SHA from target repo
        id: get_latest_sha
        run: |
          # ï¼ï¼æ ¸å¿ƒä¿®æ”¹ç‚¹1ï¼šæ›¿æ¢ä¸ºä½ çš„ã€Œç›®æ ‡ä»“åº“ã€åœ°å€ï¼ˆéœ€æ£€æµ‹æ›´æ–°çš„ä»“åº“ï¼‰
          TARGET_REPO="https://api.github.com/repos/files-community/Files/commits/main "
          # ï¼ï¼æ ¸å¿ƒä¿®æ”¹ç‚¹2ï¼šæ›¿æ¢ä¸ºç›®æ ‡ä»“åº“çš„ã€Œç›®æ ‡åˆ†æ”¯ã€ï¼ˆå¦‚ mainã€devï¼‰
          TARGET_BRANCH="main"
          
          # è°ƒç”¨ GitHub API è·å–ç›®æ ‡ä»“åº“æŒ‡å®šåˆ†æ”¯çš„æœ€æ–°æäº¤ SHA
          LATEST_SHA=$(curl -s "https://api.github.com/repos/$TARGET_REPO/commits/$TARGET_BRANCH" | jq -r '.sha')
          
          # éªŒè¯ SHA æ˜¯å¦è·å–æˆåŠŸï¼ˆé¿å… API è°ƒç”¨å¤±è´¥å¯¼è‡´ç©ºå€¼ï¼‰
          if [ -z "$LATEST_SHA" ] || [ "$LATEST_SHA" == "null" ]; then
            echo "Error: Failed to get latest SHA from $TARGET_REPO/$TARGET_BRANCH"
            exit 1
          fi
          
          # å°†æœ€æ–° SHA å­˜å…¥è¾“å‡ºå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          echo "âœ… Got latest commit SHA from $TARGET_REPO/$TARGET_BRANCH: $LATEST_SHA"

      - name: Get previous recorded SHA (from 'sha-record' branch)
        id: get_prev_sha
        run: |
          # ç”¨ç‹¬ç«‹åˆ†æ”¯ã€Œsha-recordã€è®°å½•å†å² SHAï¼ˆé¿å…æ±¡æŸ“ä¸»åˆ†æ”¯ï¼‰
          RECORD_BRANCH="sha-record"
          
          # æ£€æŸ¥ã€Œsha-recordã€åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
          if git ls-remote --heads origin "$RECORD_BRANCH" | grep -q "$RECORD_BRANCH"; then
            echo "â„¹ï¸ '$RECORD_BRANCH' branch exists, fetching previous SHA..."
            # æ‹‰å–åˆ†æ”¯å¹¶åˆ‡æ¢ï¼ˆå¤±è´¥æ—¶å¿½ç•¥é”™è¯¯ï¼Œé¿å…ä¸­æ–­æµç¨‹ï¼‰
            git fetch origin "$RECORD_BRANCH:$RECORD_BRANCH" || true
            git checkout "$RECORD_BRANCH" || true
            
            # æ£€æŸ¥å†å² SHA æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "latest_sha.txt" ]; then
              PREV_SHA=$(cat latest_sha.txt)
              echo "prev_sha=$PREV_SHA" >> $GITHUB_OUTPUT
              echo "âœ… Previous SHA found: $PREV_SHA"
            else
              echo "prev_sha=" >> $GITHUB_OUTPUT
              echo "âš ï¸ No previous SHA file in '$RECORD_BRANCH' branch"
            fi
          else
            echo "prev_sha=" >> $GITHUB_OUTPUT
            echo "âš ï¸ '$RECORD_BRANCH' branch does not exist (will create later)"
          fi
          
          # åˆ‡å›åŸåˆ†æ”¯ï¼ˆé¿å…å½±å“åç»­æ­¥éª¤ï¼‰
          git checkout ${{ github.ref_name }} || true

      - name: Compare latest SHA with previous SHA
        id: compare_sha
        run: |
          # è¯»å–æœ€æ–° SHA å’Œå†å² SHA
          CURR_SHA="${{ steps.get_latest_sha.outputs.sha }}"
          PREV_SHA="${{ steps.get_prev_sha.outputs.prev_sha }}"
          
          echo "ğŸ“Š Current SHA (target repo): $CURR_SHA"
          echo "ğŸ“Š Previous SHA (recorded): $PREV_SHA"
          
          # å¯¹æ¯” SHAï¼šè‹¥ä¸åŒï¼Œè¯´æ˜ç›®æ ‡ä»“åº“æœ‰æ–°æäº¤ï¼›è‹¥ç›¸åŒ/å†å² SHA ä¸ºç©ºï¼Œè¯´æ˜æ— æ›´æ–°æˆ–é¦–æ¬¡æ£€æµ‹
          if [ "$CURR_SHA" != "$PREV_SHA" ]; then
            echo "new_commit=true" >> $GITHUB_OUTPUT
            echo "ğŸ‰ New commit detected in target repo! Will trigger build workflow."
          else
            echo "new_commit=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new commits in target repo (or first check), skip build."
          fi

      - name: Update SHA record in 'sha-record' branch
        if: steps.compare_sha.outputs.new_commit == 'true'
        run: |
          RECORD_BRANCH="sha-record"
          LATEST_SHA="${{ steps.get_latest_sha.outputs.sha }}"
          
          # åˆ‡æ¢åˆ°ã€Œsha-recordã€åˆ†æ”¯ï¼ˆæ— åˆ™åˆ›å»ºå­¤ç«‹åˆ†æ”¯ï¼Œä¸ç»§æ‰¿ä»»ä½•å†å²ï¼‰
          git checkout "$RECORD_BRANCH" 2>/dev/null || git checkout --orphan "$RECORD_BRANCH"
          
          # æ¸…ç©ºåˆ†æ”¯å†…å®¹ï¼ˆé¿å…å†å²æ–‡ä»¶å¹²æ‰°ï¼Œä»…ä¿ç•™ SHA è®°å½•æ–‡ä»¶ï¼‰
          git rm -rf . 2>/dev/null || true
          
          # å°†æœ€æ–° SHA å†™å…¥è®°å½•æ–‡ä»¶
          echo "$LATEST_SHA" > latest_sha.txt
          
          # é…ç½® Git æäº¤èº«ä»½ï¼ˆGitHub Action å®˜æ–¹èº«ä»½ï¼‰
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Auto-Build Bot"
          
          # æäº¤å¹¶æ¨é€æ›´æ–°ï¼ˆå¤±è´¥æ—¶é€€å‡º 0ï¼Œé¿å…å› ã€Œæ— å˜æ›´ã€ä¸­æ–­æµç¨‹ï¼‰
          git add latest_sha.txt
          git commit -m "Update target repo latest SHA to $LATEST_SHA" || exit 0
          git push origin "$RECORD_BRANCH"
          
          echo "âœ… Updated SHA record to '$RECORD_BRANCH' branch"

      - name: Trigger your build workflow (e.g., build.yml)
        if: steps.compare_sha.outputs.new_commit == 'true'
        run: |
          # ï¼ï¼æ ¸å¿ƒä¿®æ”¹ç‚¹3ï¼šæ›¿æ¢ä¸ºä½ çš„ã€Œæ„å»ºå·¥ä½œæµæ–‡ä»¶åã€ï¼ˆå¦‚ build.ymlã€ci-build.ymlï¼‰
          BUILD_WORKFLOW_FILE="cd-sideload-stable.yml"
          # ï¼ï¼æ ¸å¿ƒä¿®æ”¹ç‚¹4ï¼šæ›¿æ¢ä¸ºæ„å»ºå·¥ä½œæµä¾èµ–çš„ã€Œåˆ†æ”¯ã€ï¼ˆå¦‚ mainã€devï¼‰
          BUILD_BRANCH="main"
          
          # è°ƒç”¨ GitHub API è§¦å‘æ„å»ºå·¥ä½œæµ
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$BUILD_WORKFLOW_FILE/dispatches" \
            -d '{
              "ref": "'"$BUILD_BRANCH"'",
          
          echo "âœ… Triggered build workflow: $BUILD_WORKFLOW_FILE (branch: $BUILD_BRANCH)"